---
title: "Lecture 06"
subtitle: "Generalized Measurement Models: An Introduction"
author: "Jihong Zhang"
institute: "Educational Statistics and Research Methods"
title-slide-attributes:
  data-background-image: ../Images/title_image.png
  data-background-size: contain
  data-background-opacity: "0.9"
execute: 
  echo: true
format: 
  revealjs:
    logo: ../Images/UA_Logo_Horizontal.png
    incremental: true  # choose "false "if want to show all together
    theme: [serif, ../pp.scss]
    footer:  <https://jihongzhang.org/posts/2024-01-12-syllabus-adv-multivariate-esrm-6553>
    transition: slide
    background-transition: fade
    slide-number: true
    chalkboard: true
    number-sections: false
    code-line-numbers: true
    code-link: true
    code-annotations: hover
    code-copy: true
    highlight-style: arrow
    code-block-border-left: true
    code-block-background: "#b22222"
    mermaid:
      theme: neutral
#bibliography: references.bib
---

## Today's Lecture Objectives

1.  Introduce measurement (psychometric) models in general

2.  Describe the steps needed in a psychometric model analysis

3.  Dive deeper into the observed-variables modeling aspect

# Measurement Model in general 

## Measurement Model Analysis Steps

```{mermaid}
%%| echo: false
%%{init: {"flowchart": {"htmlLabels": false}} }%%
graph TD
subgraph "Measurement Procedure"
  subgraph Modeling
  direction LR
  Start --> id1
  id1([Specify model]) --> id2(["`Specify scale identification 
  method for latent variables`"])
  id2 --> id3([Estimate model])
  id3 --> id4{Adequate fit indices}
  id4 -- No --> id1
  end
  Modeling -- Model fit acceptable --> one
  subgraph one["Evaluation: Measurement Model with Auxiliary Components"]
    direction LR
    id5(["Score estimation 
    and secondary analyses with scores"]) --> id6([Item evaluation])
    id6 --> id7([Scale construction])
    id7 --> id8([Equating])
    id8 --> id9([Measure Invariance/Differential item functioning])
    id9 --> End
  end
end
style Start fill:#f9f,stroke:#333,stroke-width:5px
style End fill:#bbf,stroke:#333,stroke-width:5px
```

## Components of a Measurement Model

There are two components of a measurement model

**Theory (what we cannot see but assume its existence):**

::: nonincremental
-   Latent variable(s)

-   Other effects as needed by a model

    ::: nonincremental
    -   Random effects (e.g., initial status and slopes in Latent Growth Model)

    -   Testlet effects (e.g., a group-level variation among items)

    -   Effects of observed variables (e.g., gender differences, DIF, Measurement Invariance)
    :::
:::

**Data (what we can see and we assume generated by theory):**

::: nonincremental
-   Outcomes

    -   An assumed distribution for each outcome

    -   A key statistic of outcome for the model (e.g., mean, sd)

    -   A link function
:::

------------------------------------------------------------------------

### General form for measurement model (SEM, IRT):

$$
f(E(\mathbf{Y}\mid\Theta)) = \boldsymbol{\mu} +\Theta\Lambda^T
$$

and

$$
\Lambda_j = Q \odot \boldsymbol{\lambda_j}
$$

Assume N as sample size, P as number of factors, J as number of items. Then,

::: nonincremental
-   $f()$: link function. CFA: identity link; IRT: logistic/probit link
-   $E(\mathbf{Y}\mid\Theta)$: Expected/Predicted values of outcomes
-   $\Theta$: latent factor scores matrix (N $\times$ P)
-   $\Lambda$: A factor loading matrix (J $\times$ P)
    -   $\Lambda_j$: $j$th row vector of factor loading matrix

    -   $\textbf{Q}$: Q-matrix represents the connections between items and latent variables

    -   $\boldsymbol{\lambda}_j$: a vector of factor loading vectors for item $j$
-   $\mu$: item intercepts (J $\times$ 1)
:::

------------------------------------------------------------------------

### Example 1 with general form

::: columns
::: {.column width="70%"}
Let's consider a measurement model with only one latent variable and five items:

```{mermaid}
%%| echo: false
%%{init: {"flowchart": {"htmlLabels": false}} }%%
flowchart TD
  id1((θ)) --> id2["Y1"]
  id1 --> id3["Y2"]
  id1 --> id4["Y3"]
  id1 --> id5["Y4"]
  id1 --> id6["Y5"]
```

The model shows:

::: nonincremental
-   One latent variable ($\theta$)

-   Five observed variables ($\mathbf{Y} = \{Y_1, Y_2, Y_3, Y_4, Y_5\}$)
:::
:::

::: {.column width="30%"}
Then,

-   $\Theta$ = $\begin{bmatrix} \theta_1, \\\theta_2,\\ \cdots,\\ \theta_N \end{bmatrix}$

-   $\Lambda^T$ = $\begin{bmatrix}\lambda_1, \lambda_2, ..., \lambda_5 \end{bmatrix}$
:::
:::

------------------------------------------------------------------------

### Example 2 with general form

::: columns
::: {.column width="70%"}
Let's consider a measurement model with only two latent variables and five items:

```{mermaid}
%%| echo: false
%%{init: {"flowchart": {"htmlLabels": false}} }%%
flowchart TD
  theta1((θ1)) --> id2["Y1"]
  theta1 --> id3["Y2"]
  theta1 --> id4["Y3"]
  theta1 --> id5["Y4"]
  theta1 --> id6["Y5"]
  theta2((θ2)) --> id2["Y1"]
  theta2 --> id3["Y2"]
  theta2 --> id4["Y3"]
  theta2 --> id5["Y4"]
  theta2 --> id6["Y5"]
```

The model shows:

::: nonincremental
-   Two latent variables ($\theta_1$, $\theta_2$)

-   Five observed variables ($\mathbf{Y} = \{Y_1, Y_2, Y_3, Y_4, Y_5\}$)
:::
:::

::: {.column width="30%"}

Then,

-   $\Theta$ = $\begin{bmatrix} \theta_{1,1}, \theta_{1,2}\\\theta_{2,1}, \theta_{2,2}\\ \cdots,\cdots \\  \theta_{N, 1}, \theta_{N,2} \end{bmatrix}$ $\sim [0, \Sigma]$

-   $\Lambda^T$ = $\begin{bmatrix}\lambda_{1,1}, \lambda_{1,2}, ..., \lambda_{1,5}\\\lambda_{2,1}, \lambda_{2,2}, ..., \lambda_{2,5}\end{bmatrix}$
:::
:::

------------------------------------------------------------------------

### Example 3 with general form 

::: columns
::: {.column width="70%"}
Let's consider a measurement model with only two latent variables and five items:

```{mermaid}
%%| echo: false
%%{init: {"flowchart": {"htmlLabels": false}} }%%
flowchart TD
  theta1((θ1)) --> id2["Y1"]
  theta1 --> id3["Y2"]
  theta1 --> id4["Y3"]
  theta2((θ2)) --> id4["Y3"]
  theta2 --> id5["Y4"]
  theta2 --> id6["Y5"]
```

The model shows:

::: nonincremental
-   Two latent variables ($\theta_1$, $\theta_2$)

-   Five observed variables ($\mathbf{Y} = \{Y_1, Y_2, Y_3, Y_4, Y_5\}$)
:::
:::

::: {.column width="30%"}

Then,

-   $\Theta$ = $\begin{bmatrix} \theta_{1,1}, \theta_{1,2}\\\theta_{2,1}, \theta_{2,2}\\ \cdots,\cdots \\  \theta_{N, 1}, \theta_{N,2} \end{bmatrix}$ $\sim [0, \Sigma]$

-   $\Lambda^T$ = $\begin{bmatrix}\lambda_{1,1}, \lambda_{1,2}, \lambda_{1,3}, 0,0\\ 0, 0, \lambda_{2,3}, \lambda_{2,4}, \lambda_{2,5}\end{bmatrix}$

-   Note that we only limit our model to main-effect models. Interaction effects of factors introduce more complexity.

-   It is difficulty to specify factor loadings with $0$s directly
:::
:::

------------------------------------------------------------------------

### Item-specific form

For each item j:

$$
\mathbf{Y_j} \sim N(\mu_j+ \boldsymbol{\lambda}_{j}Q_j\Theta, \psi_j)
$$

## Bayesian view: latent variables

Latent variables in Bayesian are built by following specification:

1.  What are their distributions? (normal distribution or others)

    -   For example, $\theta_i$ values for one person and $\theta$ values for samples. Factor score $\theta$ is a mixture distribution of distributions of each individual's factor score $\theta_i$

    -   But, in MLE/WSLMV, we do not estimate mean and sd of each individual's factor score for model to be converged

```{r}
#| code-fold: true
library(tidyverse)
set.seed(12)
N = 15
ndraws = 200
FS = matrix(NA, nrow = N, ndraws)
FS_p = rnorm(N)
FS_p = FS_p[order(FS_p)]
for (i in 1:N) {
  FS[i,] = rnorm(ndraws, mean = FS_p[i], sd = 1)
}
FS_plot <- as.data.frame(t(FS))
colnames(FS_plot) <- paste0("Person", 1:N)
FS_plot <- FS_plot |> pivot_longer(everything(), names_to = "Person", values_to = "Factor Score")
FS_plot$Person <- factor(FS_plot$Person, levels = paste0("Person", 1:N))
ggplot() +
  geom_density(aes(x = `Factor Score`, fill = Person, col = Person ), alpha = .5, data = FS_plot)  +
  geom_density(aes(x = FS_p))
```

------------------------------------------------------------------------

2.  Multidimensionality
    -    How many factors to be measured?
    -   If $\geq$ 2 factors, we specify mean vectors and variance-covariance matrix
    -   To link latent variables with observed variables, we need to create a indicator matrix of coefficient/effects of latent variable on items.
        -   In diagnostic modeling and multidimensional IRT, we call it Q-matrix

## Simulation Study 1

The model specification is a two-factor with each measured by 3 items. In total, there are 6 items with continuous responses.

### 1. Simulation settings

```{r}
load(here::here("posts", "2024-01-12-syllabus-adv-multivariate-esrm-6553", "Lecture06", "Code", "Lecture06.RData"))
fit_cfa_twofactor$summary("lambda")
```

## Wrapping up

The three lectures using linear models was built to show nearly all parts needed in a Bayesian analysis

-   MCMC specifications

-   Prior specifications

-   Assessing MCMC convergence

-   Reporting MCMC results

-   Determining if a model fits the data (absolute fit)

-   Determining which model fits the data better (relative fit)

All of these topics will be with us when we start model complicated models in our future lecture.

------------------------------------------------------------------------

## Next Class

1.  Generalized measurement models

## Other materials

1.  [Jonathan Templin's Website](https://jonathantemplin.github.io/Bayesian-Psychometric-Modeling-Course-Fall2022/lectures/lecture04b/04b_Modeling_Observed_Data)
2.  [Winston-Salem's Website](https://medewitt.github.io/resources/stan_cfa.html)
3.  [Rick Farouni's Website](https://rfarouni.github.io/assets/projects/BayesianFactorAnalysis/BayesianFactorAnalysis.html)

## Reference
